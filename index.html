<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart AI Chat+</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    .typing-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      background: white;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
      40% { transform: scale(1); opacity: 1; }
    }
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f0c29] via-[#302b63] to-[#24243e] text-white h-screen flex font-sans">

  <!-- Sidebar -->
  <aside class="w-72 bg-black/30 backdrop-blur-xl border-r border-white/10 flex flex-col shadow-xl transition-all duration-300">
    <div class="flex items-center justify-between p-4 border-b border-white/10">
      <h2 class="font-bold text-lg bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">Chats</h2>
      <button id="newChatBtn" class="p-2 rounded-lg hover:bg-white/10 transition">
        <i data-lucide="plus" class="w-5 h-5 text-white"></i>
      </button>
    </div>
    <nav id="chatHistory" class="flex-1 overflow-y-auto p-2 space-y-1 text-sm">
      <!-- Chat list -->
    </nav>
    <div class="p-4 border-t border-white/10 flex items-center justify-between text-xs text-gray-400">
      <span>⚡ Smart AI Chat+</span>
      <button class="p-1 hover:bg-white/10 rounded">
        <i data-lucide="settings" class="w-4 h-4 text-white"></i>
      </button>
    </div>
  </aside>

  <!-- Main -->
  <div class="flex-1 flex flex-col">
    <header class="px-6 py-4 bg-black/30 backdrop-blur-xl border-b border-white/10 sticky top-0 z-10 flex items-center justify-between">
      <h1 class="font-bold text-xl bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">🤖 Smart AI Chat+</h1>
      <div class="flex gap-3">
        <button class="p-2 rounded-lg hover:bg-white/10 transition">
          <i data-lucide="moon" class="w-5 h-5 text-white"></i>
        </button>
        <button class="p-2 rounded-lg hover:bg-white/10 transition">
          <i data-lucide="info" class="w-5 h-5 text-white"></i>
        </button>
      </div>
    </header>

    <!-- Chat -->
    <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

    <!-- Input -->
    <div class="flex flex-col gap-3 p-4 bg-black/30 border-t border-white/10 backdrop-blur-xl">
      <div id="dropZone" 
        class="px-4 py-3 rounded-xl border-2 border-dashed border-gray-600 text-sm text-gray-400 text-center hover:border-purple-400 hover:text-purple-300 transition cursor-pointer">
        Drag & Drop Images Here (or click to upload)
      </div>
      <div class="flex items-center gap-3">
        <input id="userInput" type="text" placeholder="Type your message..." 
          class="flex-1 px-4 py-3 rounded-xl bg-gray-800/60 border border-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
        <button id="sendBtn" 
          class="p-3 rounded-xl font-medium bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90 transition flex items-center gap-2">
          <i data-lucide="send" class="w-5 h-5 text-white"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons(); // init icons

    const chatBox = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const dropZone = document.getElementById("dropZone");
    const newChatBtn = document.getElementById("newChatBtn");
    const chatHistoryEl = document.getElementById("chatHistory");
    const MODEL = "gpt-5-nano";

    const SYSTEM_PROMPT = `
You are Smart AI Chat+. 
Be a conversational, smart tutor with memory. 
Use modern formatting, explain math step-by-step, and analyze images if provided.
`;

    let chats = [];
    let activeChatId = null;
    let pendingImages = [];

    function createNewChat() {
      const id = Date.now().toString();
      const chat = {
        id,
        title: "New Chat",
        messages: [
          { role: "system", content: [{ type: "text", text: SYSTEM_PROMPT }] }
        ]
      };
      chats.push(chat);
      activeChatId = id;
      renderChatHistory();
      renderChat(chat);
    }

    function renderChatHistory() {
      chatHistoryEl.innerHTML = "";
      chats.forEach(chat => {
        const btn = document.createElement("button");
        btn.className = `w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/10 transition truncate ${
          chat.id === activeChatId ? "bg-white/10" : ""
        }`;
        btn.innerHTML = `<i data-lucide="message-circle" class="w-4 h-4 text-white"></i><span>${chat.title}</span>`;
        btn.onclick = () => {
          activeChatId = chat.id;
          renderChat(chat);
          renderChatHistory();
          lucide.createIcons();
        };
        chatHistoryEl.appendChild(btn);
      });
      lucide.createIcons();
    }

    function renderChat(chat) {
      chatBox.innerHTML = "";
      chat.messages.forEach(msg => {
        const text = msg.content.find(c => c.type === "text")?.text || "";
        const imgs = msg.content.filter(c => c.type === "image").map(c => c.src);
        addMessage(msg.role, text, imgs);
      });
    }

    function addMessage(role, text, imgs = [], isTyping=false) {
      const wrapper = document.createElement("div");
      wrapper.className = `flex ${role==="user" ? "justify-end" : "justify-start"} w-full fade-in`;

      const bubble = document.createElement("div");
      bubble.className = `max-w-[75%] px-4 py-3 rounded-2xl whitespace-pre-wrap text-sm shadow-lg ${
        role === "user" 
        ? "bg-gradient-to-r from-blue-500 to-purple-500 text-white font-medium" 
        : "bg-gray-900/70 border border-gray-700 text-gray-200"
      } transition`;

      if (isTyping) {
        const dots = document.createElement("div");
        dots.className = "typing-dots flex gap-1";
        dots.innerHTML = "<span></span><span></span><span></span>";
        bubble.appendChild(dots);
      } else {
        bubble.textContent = text;
      }

      if (imgs.length) {
        imgs.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.className = "mt-3 max-w-[200px] rounded-xl border border-gray-700";
          bubble.appendChild(document.createElement("br"));
          bubble.appendChild(img);
        });
      }

      wrapper.appendChild(bubble);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      return bubble;
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && pendingImages.length === 0) return;
      userInput.value = "";

      const chat = chats.find(c => c.id === activeChatId);
      if (!chat) return;

      addMessage("user", text, pendingImages);

      const userEntry = { role: "user", content: [] };
      if (text) userEntry.content.push({ type: "text", text });
      pendingImages.forEach(src => userEntry.content.push({ type: "image", src }));
      chat.messages.push(userEntry);

      if (chat.title === "New Chat" && text) {
        chat.title = text.slice(0, 30) + (text.length > 30 ? "…" : "");
        renderChatHistory();
      }

      pendingImages = [];
      dropZone.textContent = "Drag & Drop Images Here (or click to upload)";

      const aiBubble = addMessage("assistant", "", [], true);

      try {
        let answer = "";
        const resp = await puter.ai.chat(chat.messages, { model: MODEL, stream: true });
        for await (const part of resp) {
          if (part?.text) {
            answer += part.text;
            aiBubble.textContent = answer;
          }
        }
        chat.messages.push({ role: "assistant", content: [{ type: "text", text: answer }] });
      } catch (e) {
        console.error("AI error:", e);
        aiBubble.textContent = "⚠️ Error: " + e.message;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    newChatBtn.addEventListener("click", createNewChat);

    // Drag & Drop
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("border-purple-400", "text-purple-300");
      handleFiles(e.dataTransfer.files);
    });
    dropZone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.multiple = true;
      input.onchange = () => handleFiles(input.files);
      input.click();
    });

    function handleFiles(files) {
      [...files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          pendingImages.push(e.target.result);
          dropZone.textContent = `${pendingImages.length} image(s) ready`;
        };
        reader.readAsDataURL(file);
      });
    }

    createNewChat();
  </script>
</body>
</html>
