<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-black to-gray-800 text-white h-screen flex flex-col">

  <!-- Header -->
  <header class="px-6 py-4 bg-black/30 backdrop-blur-md border-b border-white/10 text-center font-semibold text-lg">
    🤖 Smart AI Chat
  </header>

  <!-- Chat Area -->
  <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

  <!-- Input + Send -->
  <div class="flex items-center gap-3 p-4 bg-black/40 border-t border-white/10 backdrop-blur-md">
    <input id="userInput" type="text" placeholder="Type your message..." 
      class="flex-1 px-4 py-3 rounded-xl bg-gray-800/80 border border-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
    <button id="sendBtn" 
      class="px-5 py-3 rounded-xl font-medium bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90 transition">
      Send
    </button>
  </div>

  <!-- Drag & Drop Zone -->
  <div id="dropZone" 
    class="m-3 px-4 py-3 rounded-xl border-2 border-dashed border-gray-600 text-sm text-gray-400 text-center hover:border-purple-400 transition cursor-pointer">
    Drag & Drop Images Here (optional)
  </div>

  <script>
    const chatBox = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const dropZone = document.getElementById("dropZone");
    const MODEL = "gpt-5-nano";

    // 🔑 System prompt
    const SYSTEM_PROMPT = `
You are Smart AI Chat. You are a helpful, conversational AI tutor.
- Always give clear, step-by-step reasoning.
- Use proper math notation (e.g., x^2 instead of x2).
- If images are provided, analyze them as part of the question.
- Be concise but thorough.
`;

    // Conversation history
    let messages = [
      { role: "system", content: [ { type: "text", text: SYSTEM_PROMPT } ] }
    ];
    let pendingImages = [];

    function addMessage(role, text, imgs = []) {
      const wrapper = document.createElement("div");
      wrapper.className = `max-w-[75%] px-4 py-3 rounded-2xl whitespace-pre-wrap text-sm shadow-lg ${
        role === "user" 
        ? "self-end bg-gradient-to-r from-blue-500 to-purple-500 text-white font-medium" 
        : "self-start bg-gray-800/80 border border-gray-700 text-gray-200"
      }`;
      wrapper.textContent = text;

      // Add images
      if (imgs.length) {
        imgs.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.className = "mt-3 max-w-[200px] rounded-xl border border-gray-700";
          wrapper.appendChild(document.createElement("br"));
          wrapper.appendChild(img);
        });
      }

      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      return wrapper;
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && pendingImages.length === 0) return;
      userInput.value = "";

      addMessage("user", text, pendingImages);

      const userEntry = { role: "user", content: [] };
      if (text) userEntry.content.push({ type: "text", text });
      pendingImages.forEach(src => userEntry.content.push({ type: "image", src }));
      messages.push(userEntry);

      pendingImages = [];
      dropZone.textContent = "Drag & Drop Images Here (optional)";

      const aiMsg = addMessage("ai", "Thinking...");

      try {
        let answer = "";
        const resp = await puter.ai.chat(messages, { model: MODEL, stream: true });
        for await (const part of resp) {
          if (part?.text) {
            answer += part.text;
            aiMsg.textContent = answer;
          }
        }
        messages.push({ role: "assistant", content: [{ type: "text", text: answer }] });
      } catch (e) {
        console.error("AI error:", e);
        aiMsg.textContent = "⚠️ Error: " + e.message;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    // Drag & Drop
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("border-purple-400", "text-purple-300");
      handleFiles(e.dataTransfer.files);
    });
    dropZone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.multiple = true;
      input.onchange = () => handleFiles(input.files);
      input.click();
    });

    function handleFiles(files) {
      [...files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          pendingImages.push(e.target.result);
          dropZone.textContent = `${pendingImages.length} image(s) ready`;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
