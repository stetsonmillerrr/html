<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart AI Chat+</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    /* Typing dots animation */
    .typing-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      background: white;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f0c29] via-[#302b63] to-[#24243e] text-white h-screen flex flex-col font-sans">

  <!-- Header -->
  <header class="px-6 py-4 bg-black/40 backdrop-blur-md border-b border-white/10 flex items-center justify-between sticky top-0 z-10">
    <h1 class="font-bold text-lg bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
      🤖 Smart AI Chat+
    </h1>
    <button id="resetBtn" 
      class="px-3 py-1.5 rounded-lg border border-white/20 hover:bg-white/10 transition text-sm text-gray-300">
      New Chat
    </button>
  </header>

  <!-- Chat Area -->
  <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

  <!-- Input -->
  <div class="flex flex-col gap-3 p-4 bg-black/30 border-t border-white/10 backdrop-blur-md">
    <div id="dropZone" 
      class="px-4 py-3 rounded-xl border-2 border-dashed border-gray-600 text-sm text-gray-400 text-center hover:border-purple-400 transition cursor-pointer">
      Drag & Drop Images Here (or click to upload)
    </div>
    <div class="flex items-center gap-3">
      <input id="userInput" type="text" placeholder="Type your message..." 
        class="flex-1 px-4 py-3 rounded-xl bg-gray-800/60 border border-gray-700 placeholder-gray-400 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
      <button id="sendBtn" 
        class="px-5 py-3 rounded-xl font-medium bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90 transition">
        Send
      </button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const dropZone = document.getElementById("dropZone");
    const resetBtn = document.getElementById("resetBtn");
    const MODEL = "gpt-5-nano";

    // 🔑 System prompt
    const SYSTEM_PROMPT = `
You are Smart AI Chat+. You are a helpful, conversational AI tutor and assistant.
- Always give clear, step-by-step reasoning.
- Use proper math notation (e.g., x^2 instead of x2).
- If images are provided, analyze them as part of the question.
- Be conversational, concise, but thorough.
- Remember context from the conversation.
`;

    // Conversation history
    let messages = [
      { role: "system", content: [ { type: "text", text: SYSTEM_PROMPT } ] }
    ];
    let pendingImages = [];

    // UI: Add message
    function addMessage(role, text, imgs = [], isTyping=false) {
      const wrapper = document.createElement("div");
      wrapper.className = `flex ${role==="user" ? "justify-end" : "justify-start"} w-full`;

      const bubble = document.createElement("div");
      bubble.className = `max-w-[75%] px-4 py-3 rounded-2xl whitespace-pre-wrap text-sm shadow-lg transition ${
        role === "user" 
        ? "bg-gradient-to-r from-blue-500 to-purple-500 text-white font-medium" 
        : "bg-gray-900/70 border border-gray-700 text-gray-200"
      }`;

      if (isTyping) {
        const dots = document.createElement("div");
        dots.className = "typing-dots flex gap-1";
        dots.innerHTML = "<span></span><span></span><span></span>";
        bubble.appendChild(dots);
      } else {
        bubble.textContent = text;
      }

      // Add images
      if (imgs.length) {
        imgs.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.className = "mt-3 max-w-[200px] rounded-xl border border-gray-700";
          bubble.appendChild(document.createElement("br"));
          bubble.appendChild(img);
        });
      }

      wrapper.appendChild(bubble);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      return bubble;
    }

    // Send message
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && pendingImages.length === 0) return;
      userInput.value = "";

      addMessage("user", text, pendingImages);

      const userEntry = { role: "user", content: [] };
      if (text) userEntry.content.push({ type: "text", text });
      pendingImages.forEach(src => userEntry.content.push({ type: "image", src }));
      messages.push(userEntry);

      pendingImages = [];
      dropZone.textContent = "Drag & Drop Images Here (or click to upload)";

      const aiBubble = addMessage("ai", "", [], true);

      try {
        let answer = "";
        const resp = await puter.ai.chat(messages, { model: MODEL, stream: true });
        for await (const part of resp) {
          if (part?.text) {
            answer += part.text;
            aiBubble.textContent = answer;
          }
        }
        messages.push({ role: "assistant", content: [{ type: "text", text: answer }] });
      } catch (e) {
        console.error("AI error:", e);
        aiBubble.textContent = "⚠️ Error: " + e.message;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    // Reset chat
    resetBtn.addEventListener("click", () => {
      chatBox.innerHTML = "";
      messages = [
        { role: "system", content: [ { type: "text", text: SYSTEM_PROMPT } ] }
      ];
      addMessage("ai", "✨ New chat started!");
    });

    // Drag & Drop
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-purple-400", "text-purple-300");
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("border-purple-400", "text-purple-300");
      handleFiles(e.dataTransfer.files);
    });
    dropZone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.multiple = true;
      input.onchange = () => handleFiles(input.files);
      input.click();
    });

    function handleFiles(files) {
      [...files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          pendingImages.push(e.target.result);
          dropZone.textContent = `${pendingImages.length} image(s) ready`;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
